# Linux Kernel

- ldd命令:
    - print shared library dependencies
    - `ldd [OPTION]... FILE...`
    - `ldd /bin/ls`

- 内核设计体系: 单内核, 微内核

- Linux: 单内核设计, 但充分借鉴了微内核体系的设计的优点: 为内核引入了模块化机制;
    - 内核的组成部分:
        - kernel: 内核核心, 一般为bzImage, 通常位于/boot目录, 名称为vmlinuz-VERSION-release, 如: /boot/vmlinuz-3.10.0-693.el7.x86_64
        - kernel object: 内核对象, 即内核模块, 一般放置于/lib/modules/VERSION-release/, 如: ll /lib/modules/3.10.0-693.el7.x86_64/
            - 内核模块与内核核心版本一定要严格匹配;
                - `[ ]`: N, 不编译此部分
                - `[M]`: Module, 编译成内核模块
                - `[*]`: Y, 编译进内核核心
            - 内核: 动态装载和卸载;
        - ramdisk: 辅助性文件, 并非必须, 这取决于内核是否能直接驱动rootfs(根文件系统)所在的设备; 是一个简装版的根文件系统; 其可以加载的内容包括:
            - 目标设备驱动, 如SCSI设备的驱动;
            - 逻辑设备驱动, 如LVM设备的驱动;
            - 文件系统, 如xfs文件系统;

- 内核信息获取, uname命令:
    - print system information
    - 格式: `uname [OPTION]...`
        - -r: 内核的release号
        - -n: 主机名

- 模块信息获取和管理:
    - lsmod命令: Show the status of modules in the Linux Kernel, 显示的内核来自于/proc/modules
    - modinfo命令: Show information about a Linux Kernel module
        - `modinfo [-F field] [-k kernel] [modulename|filename...]`
            - -F field: 仅显示指定字段的信息;
            - -n: 显示文件路径;
    - modprobe命令: Add and remove modules from the Linux Kernel
        - `modprobe  [-r]  module_name`
            - 模块的动态装载: `modprobe module_name`
            - 动态卸载: `modprobe -r module_name`
    - depmod命令: Generate modules.dep and map files. 内核模块依赖关系文件的生成工具;
    - insmod命令: Simple program to insert a module into the Linux Kernel
        - `insmod [filename] [module options...]`; **filename**: 模块文件的文件路径;
    - rmmod命令: Simple program to remove a module from the Linux Kernel
        - `rmmod [-f] [-s] [-v] [modulename]`

- ramdisk文件的管理:
    - (1) mkinitrd命令: a compat wrapper, which calls dracut to generate an initramfs, 为当前使用中的内核重新制作ramdisk文件
        - `mkinitrd [OPTION...] [<initrd-image>] <kernel-version>`
            - `--with=<module>`: 除了默认的模块之外需要装载至initramfs中的模块;
            - `--preload=<module>`: initramfs所提供的模块需要预先装载的模块;
        - 示例: `mkinitrd /boot/initramfs-$(uname -r).img $(uname -r)`
    - (2) dracut命令: low-level tool for generating an initramfs image
        - `dracut [OPTION...] [<image> [<kernel version>]]`
        - 示例: `dracut /boot/initramfs-$(uname -r).img $(uname -r)`

- 内核信息输出的伪文件系统:
    - /proc: 内核状态和统计信息的输出接口; 同时, 还提供一个配置接口, /proc/sys;
        - 只读: 信息输出; 例如/proc/#/*
        - 可写: 可接受用户指定一个“新值”来实现对内核某功能或特性的配置;
            - /proc/sys/: net/ipv4/ip_forward 相当于 net.ipv4.ip_forward
                - (1) sysctl命令: 专用于查看或设定/proc/sys目录下参数的值;
                    - `sysctl [options]  [variable[=value]]`
                        - 查看:
                            - `sysctl -a`
                            - `sysctl  variable`
                        - 修改其值: `sysctl -w variable=value`
                - (2) 文件系统命令(cat, echo)
                    - 查看: `cat /proc/sys/PATH/TO/SOME_KERNEL_FILE`
                    - 设定:`echo "VALUE" > /proc/sys/PATH/TO/SOME_KERNEL_FILE`
                    - 注意: 上述两种方式的设定仅当前运行内核有效;
                - (3) 配置文件: `/etc/sysctl.conf`, `/etc/sysctl.d/*.conf`
                    - 立即生效的方式: `sysctl -p [/PATH/TO/CONFIG_FILE]`
        - 内核参数:
            - net.ipv4.ip_forward: 核心转发;
            - vm.drop_caches: 手动回收内存: https://www.jianshu.com/p/016f7cf0380d
            - kernel.hostname: 主机名;
            - net.ipv4.icmp_echo_ignore_all: 忽略所有ping操作;
    - /sys目录:
        - sysfs: 输出内核识别出的各硬件设备的相关属性信息, 也有内核对硬件特性的可设置参数; 对此些参数的修改, 即可定制硬件设备工作特性;
        - udev: 通过读取/sys目录下的硬件设备信息按需为各硬件设备创建设备文件;
            - 用户空间程序;
            - 专用工具: devadmin, hotplug;
            - udev为设备创建设备文件时, 会读取其事先定义好的规则文件, 一般在/etc/udev/rules.d/目录下, 以及/usr/lib/udev/rules.d/目录下;
